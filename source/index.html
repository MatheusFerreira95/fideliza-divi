<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fideliza Divi App</title>
    <link rel="icon" href="logo.png" type="image/x-icon" />

    <!-- Material Design Lite   -->
    <link
      rel="stylesheet"
      href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"
    />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <style>
      body {
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }
      .page-content {
        padding: 20px;
      }
      .logo {
        height: 36px;
        margin-right: 10px;
        border-radius: 6px;
      }
      .card {
        margin-bottom: 20px;
      }
      .flex-row {
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body onload="inicializarAgendamentos(); mostrarRelatorio();">
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <img src="logo.png" class="logo" alt="Logo" />
          <span class="mdl-layout-title">Fideliza Divi</span>
        </div>
      </header>

      <main class="mdl-layout__content">
        <div class="page-content">
          <!-- Agendamento -->
          <h4>Agendamento de Serviços</h4>
          <div
            class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"
          >
            <input class="mdl-textfield__input" type="text" id="nome" />
            <label class="mdl-textfield__label" for="nome">Nome</label>
          </div>
          <div
            class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"
          >
            <input class="mdl-textfield__input" type="text" id="veiculo" />
            <label class="mdl-textfield__label" for="veiculo">Veículo</label>
          </div>
          <div
            class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"
          >
            <input class="mdl-textfield__input" type="tel" id="telefone" />
            <label class="mdl-textfield__label" for="telefone">Telefone</label>
          </div>
          <div
            class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"
          >
            <input class="mdl-textfield__input" type="text" id="servico" />
            <label class="mdl-textfield__label" for="servico">Serviço</label>
          </div>
          <input
            type="datetime-local"
            id="dataHora"
            class="mdl-textfield__input"
          />
          <br /><br />
          <button
            class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
            onclick="salvar()"
          >
            Salvar
          </button>

          <h4>Consulta: Clientes há X dias sem atendimento</h4>
          <div class="flex-row">
            <input
              class="mdl-textfield__input"
              type="number"
              id="diasSem"
              placeholder="Dias"
            />
            <button
              class="mdl-button mdl-js-button mdl-button--raised"
              onclick="consultarFaltantes()"
            >
              Consultar
            </button>
          </div>
          <div id="faltantes"></div>

          <h4>Relatório Histórico</h4>
          <div
            class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"
          >
            <input
              class="mdl-textfield__input"
              type="text"
              id="filtrarCliente"
              oninput="filtrar()"
            />
            <label class="mdl-textfield__label" for="filtrarCliente"
              >Filtrar Cliente</label
            >
          </div>
          <div id="relatorio"></div>
        </div>
      </main>
    </div>

    <script>
      function inicializarAgendamentos() {
        let lista = JSON.parse(localStorage.getItem("agendamentos") || "[]");

        let atualizado = false;
        lista = lista.map(item => {
          if (!item.id) {
            item.id = Date.now() + Math.floor(Math.random() * 1000);
            atualizado = true;
          }
          return item;
        });

        if (atualizado) {
          localStorage.setItem("agendamentos", JSON.stringify(lista));
        }
      }

      function salvar() {
        const dados = {
          id: Date.now(),
          nome: document.getElementById("nome").value,
          veiculo: document.getElementById("veiculo").value,
          telefone: document.getElementById("telefone").value,
          servico: document.getElementById("servico").value,
          dataHora: document.getElementById("dataHora").value
        };
        if (!dados.nome || !dados.dataHora) {
          alert("Nome e data são obrigatórios!");
          return;
        }
        const lista = JSON.parse(localStorage.getItem("agendamentos") || "[]");
        lista.push(dados);
        localStorage.setItem("agendamentos", JSON.stringify(lista));
        limparCampos();
        mostrarRelatorio();
      }

      function limparCampos() {
        ["nome", "veiculo", "telefone", "servico", "dataHora"].forEach(
          id => (document.getElementById(id).value = "")
        );
      }

      function mostrarRelatorio(filtro) {
        const dados = filtro
          ? filtro
          : JSON.parse(localStorage.getItem("agendamentos") || "[]");
        dados.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
        const agrupado = {};
        for (const d of dados) {
          const dia = d.dataHora.split("T")[0];
          if (!agrupado[dia]) agrupado[dia] = [];
          agrupado[dia].push(d);
        }
        const relatorioDiv = document.getElementById("relatorio");
        relatorioDiv.innerHTML = "";
        Object.keys(agrupado)
          .sort((a, b) => b.localeCompare(a))
          .forEach(dia => {
            const card = document.createElement("div");
            card.className = "mdl-card mdl-shadow--2dp card";
            card.innerHTML =
              `<div class="mdl-card__title"><h6>${dia}</h6></div><div class="mdl-card__supporting-text">` +
              agrupado[dia]
                .map((e, index) => {
                  const tel = e.telefone.replace(/\D/g, "");
                  return `<p>${e.nome} - ${e.veiculo} - ${e.servico} -
                      <a href="https://wa.me/55${tel}" target="_blank">${e.telefone}</a>
                      <button class="mdl-button mdl-js-button mdl-button--icon" onclick="deletar(${e.id})">
                        <i class="material-icons">delete</i></button></p>`;
                })
                .join("") +
              "</div>";
            relatorioDiv.appendChild(card);
          });
      }

      function filtrar() {
        const input = document.getElementById("filtrarCliente");
        const filtro = input.value.toLowerCase();
        const agendamentos = JSON.parse(
          localStorage.getItem("agendamentos") || "[]"
        );
        let agendamentosFiltrado = [];

        agendamentos.forEach(agendamento => {
          const nomeCliente = agendamento.nome.toLowerCase();
          if (nomeCliente.includes(filtro)) {
            agendamentosFiltrado.push(agendamento);
          }
        });

        mostrarRelatorio(agendamentosFiltrado);
      }

      function deletar(id) {
        if (confirm("Tem certeza que deseja deletar?")) {
          let lista = JSON.parse(localStorage.getItem("agendamentos") || "[]");

          lista = lista.filter(item => item.id !== id);
          localStorage.setItem("agendamentos", JSON.stringify(lista));

          mostrarRelatorio();
        }
      }

      function consultarFaltantes() {
        const dias = parseInt(document.getElementById("diasSem").value);
        if (!dias) return alert("Informe os dias!");
        const limite = new Date();
        limite.setDate(limite.getDate() - dias);
        const dados = JSON.parse(localStorage.getItem("agendamentos") || "[]");

        const ultimoServicoPorCliente = {};
        dados.forEach(d => {
          if (
            !ultimoServicoPorCliente[d.nome] ||
            new Date(d.dataHora) >
              new Date(ultimoServicoPorCliente[d.nome].dataHora)
          ) {
            ultimoServicoPorCliente[d.nome] = d;
          }
        });

        const resultado = Object.entries(ultimoServicoPorCliente).filter(
          ([_, cliente]) =>
            new Date(cliente.dataHora).toDateString() === limite.toDateString()
        );

        const faltantesDiv = document.getElementById("faltantes");
        faltantesDiv.innerHTML =
          `<p><strong>Total: ${resultado.length}</strong></p><ul>` +
          resultado
            .map(e => {
              const tel = e[1].telefone.replace(/\D/g, "");
              return `<li>${e[1].nome} - ${e[1].veiculo} - ${e[1].servico} -
                  <a href="https://wa.me/55${tel}" target="_blank">${e[1].telefone}</a></li>`;
            })
            .join("") +
          "</ul>";
      }

      mostrarRelatorio();
    </script>
  </body>
</html>
